<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>fuck de system</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
      integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
      crossorigin=""
    ></script>
    <script src="node_modules/axios/dist/axios.min.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="http://yui.yahooapis.com/3.18.1/build/cssnormalize/cssnormalize-min.css"
    />
    <style>
      body {
        overflow: hidden;
      }
      * {
        font-family: "Segoe UI", "Roboto", "Comic Sans", "Comic Sans MS" !important;
      }
      #mapid {
        height: 100vh;
        width: 100vw;
      }
      .leaflet-popup-header {
        border-bottom: 2px solid #212121;
        padding-bottom: 10px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
      }
      .leaflet-popup-publicatie {
        max-height: 250px;
        overflow: auto;
      }
      .kvk-paneel {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 250px;
        max-height: 40%;
        z-index: 500;
        transition: 0.2s ease-in-out 0.2s;
        transform: translateY(150%);
      }
      .kvk-paneel.open {
        transform: translateY(0);
      }
      .kvk-paneel-binnen {
        position: relative;
        padding: 20px;
        background-color: white;
        height: 100%;
      }
      .sluit-kvk-paneel {
        background-color: transparent;
        padding: 0;
        border: 0;
        font-size: 50px;
        position: absolute;
        right: 0;
        top: -80px;
        transform: scale(1) translateY(0) translateX(0);
        transition: 0.2s ease-in-out;
      }
      .sluit-kvk-paneel.groot {
        transform: scale(5) translateY(-50px) translateX(-100px);
      }
      .kvk-resultaat {
        max-height: calc(100% - 40px);
        max-width: calc(100% - 120px);
        overflow: auto;
        transform: translateX(0);
        transition: 0.2s ease;
      }
      .kvk-resultaat.ladend {
        transform: translateX(-150%);
      }
      .kvk-nummers {
        position: absolute;
        max-height: calc(100% - 70px);
        overflow: auto;
        top: 10px;
        right: 10px;
        list-style-type: none;
        padding: 0;
        margin: 0;
        width: 129px;
        text-align: center;
        font-weight: bold;
        font-size: 20px;
      }
      .kvk-nummers li + li {
        margin-top: 10px;
        width: 100%;
      }
      .knopje {
        border: 0;
        background-color: rgb(122, 21, 21);
        font-weight: bold;
        padding: 10px;
        color: white;
        transition: 0.2s ease;
      }
      .knopje:hover {
        background-color: rgb(122, 41, 21);
      }
      .kvk-resultaat ul {
        padding: 0;
        margin: 0;
        list-style-type: none;
        display: flex;
        flex-wrap: wrap;
      }
      .kvk-resultaat ul li {
        flex-basis: 250px;
        font-size: 12px;
      }
      .leaflet-control-attribution > strong {
        margin-left: 10px;
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <div id="mapid"></div>
    <div class="kvk-paneel" id="kvk-paneel">
      <div class="kvk-paneel-binnen">
        <ul class="kvk-nummers" id="kvk-nummers"></ul>
        <div class="kvk-resultaat" id="kvk-resultaat"></div>
        <button class="sluit-kvk-paneel" id="sluit-kvk-paneel">😎</button>
      </div>
    </div>
    <script>
      const correcteMeningen = [
        {
          tekst: "Vind je Friesland ook zo belangrijk?",
          naam: "friesland",
          wegsturenMet: "Maar suikerbrood dan 😥",
          wegsturenNaar: "https://www.youtube.com/watch?v=8mvHcJvdBE8",
          correcteAntwoord: true,
          antwoordGegeven: null,
        },
        {
          tekst:
            "Het is niet mooi.... maar Feyenoord doet wel altijd hun best.",
          wegsturenMet: "Foutieve mening ⚽",
          wegsturenNaar: "https://www.youtube.com/watch?v=_Z01TTEMtNA",
          naam: "voetbal-1",
          correcteAntwoord: false,
          antwoordGegeven: null,
        },
        {
          tekst: "Mathijs de Ligt had gewoon moeten blijven, die sukkel",
          wegsturenNaar: "https://www.youtube.com/watch?v=jejtIxSeV_4",
          wegsturenMet: "❌\n❌\n❌\n",
          naam: "voetbal-2",
          correcteAntwoord: true,
          antwoordGegeven: null,
        },
      ];

      if (!sessionStorage.getItem("snaptHet")) {
        sessionStorage.setItem("snaptHet", JSON.stringify(correcteMeningen));
      }

      let faillissementen;
      const eerdereAntwoorden = JSON.parse(sessionStorage.getItem("snaptHet"));

      const spelVragen = eerdereAntwoorden.filter(
        (a) => !a.antwoordGegeven && a.antwoordGegeven !== a.correcteAntwoord
      );
      const spelVraagIndex = Math.ceil(Math.random() * (spelVragen.length - 1));
      const spelVraag = spelVragen[spelVraagIndex];
      if (Math.random() * 10 > 8 && typeof spelVraag !== "undefined") {
        spelVraag.antwoordGegeven = confirm(spelVraag.tekst);
        console.log(spelVraag.antwoordGegeven);
        if (spelVraag.correcteAntwoord === spelVraag.antwoordGegeven) {
          alert("🥰🥰🥰");
        } else {
          alert(spelVraag.wegsturenMet);
          location.href = spelVraag.wegsturenNaar;
        }
        eerdereAntwoorden.forEach((a) => {
          if (a.naam === spelVraag.naam) {
            a.antwoordGegeven = spelVraag.antwoordGegeven;
          }
        });
        sessionStorage.setItem("snaptHet", JSON.stringify(eerdereAntwoorden));
      }

      function initMap() {
        const mymap = L.map("mapid").setView([52.3948545, 4.9336231], 11);
        L.tileLayer(
          "https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoic2plcnAtdmFuLXdvdWRlbiIsImEiOiJjajh5NmExaTAxa29iMzJwbDV0eXF4eXh4In0.HVBgF1SbusJzMwmjHcHS2w",
          {
            attribution:
              '<span id="map-info"></span> <strong>NOOOORD</strong>Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: "mapbox/streets-v11",
            tileSize: 512,
            zoomOffset: -1,
            accessToken: "your.mapbox.access.token",
          }
        ).addTo(mymap);
        return mymap;
      }

      window.onload = function () {
        const mymap = initMap();
        const vandaag = new Date().getTime();

        fetch("opslag/geconsolideerde-adressen.json")
          .then((res) => {
            return res.json();
          })
          .then((faillissementenRes) => {
            faillissementen = faillissementenRes;

            zetMapInfo(faillissementen);

            const markers = faillissementen.map((faillissement) => {
              // verder in het verleden opacity geven.
              let opacity = 1;
              if (!!faillissement.datum) {
                const fDatum = new Date(faillissement.datum).getTime();
                // To calculate the no. of days between two dates
                var verschilInDagen = (fDatum - vandaag) / (1000 * 3600 * 24);
                const verschilNietBovenNul = Math.max(0, verschilInDagen) / 10;
                opacity = opacity - verschilNietBovenNul;
                opacity = Math.max(opacity, 0.3);
              }

              const marker = L.marker([
                faillissement.lat,
                faillissement.lon,
                {
                  opacity: opacity,
                },
              ]).addTo(mymap);

              const datumHTML = faillissement.datum
                ? `<h3>${new Date().toDateString()}</h3>`
                : "";

              marker.bindPopup(
                `<div class='leaflet-popup-publicatie'>
                  <header class='leaflet-popup-header'>
                  ${datumHTML}
                    <button class='open-kvk knopje' data-osm-id='${faillissement.osm_id}'>KvK paneel</button>
                    </header>
                    ${faillissement.publicaties}

                  </div class='leaflet-popup-publicatie'>`
              );
            });
          })
          .catch((err) => {
            console.error(err);
          });

        document
          .getElementsByTagName("body")[0]
          .addEventListener("click", function (e) {
            if (e.target.classList.contains("open-kvk")) {
              const kvkNummers = faillissementen.find(
                (f) => f.osm_id === e.target.getAttribute("data-osm-id")
              ).kvk;

              if (!kvkNummers || !kvkNummers.length) {
                alert(
                  "ik kon geen kvk nummer vinden. Of tenminste, me algoritme niet. Lag niet aan mij dus.😴"
                );
                return;
              }

              haalKvkInfoEnPrint(kvkNummers[0], true, kvkNummers);

              //data-osm-id
            }
            //open - kvk;
          });

        function haalKvkInfoEnPrint(
          kvkNummer,
          geheelNieuw = false,
          kvkNummers = []
        ) {
          if (!geheelNieuw) {
            document.getElementById("kvk-resultaat").classList.add("ladend");
          }
          axios
            .get(
              `https://zoeken.kvk.nl/search.ashx?handelsnaam=&kvknummer=${kvkNummer}&straat=&postcode=&huisnummer=&plaats=&hoofdvestiging=1&rechtspersoon=1&nevenvestiging=1&zoekvervallen=0&zoekuitgeschreven=1&start=0&error=false&searchfield=uitgebreidzoeken&_=1589332056667`
            )
            .then((kvkResponse) => {
              document.getElementById("kvk-resultaat").innerHTML =
                kvkResponse.data;
              if (geheelNieuw) {
                document.getElementById("kvk-nummers").innerHTML = `
                        <li>KVK 🕵️‍♂️</li>
                      ${kvkNummers
                        .map((kvkNr) => {
                          return `<li><button class='knopje' class='wissel-kvk' data-kvk-nr='${kvkNr}'>${kvkNr}</button></li>`;
                        })
                        .join("")}`;
                document.getElementById("kvk-paneel").classList.add("groot");
                setTimeout(function () {
                  document.getElementById("kvk-paneel").classList.add("open");
                }, 350);
                setTimeout(function () {
                  document
                    .getElementById("kvk-paneel")
                    .classList.remove("groot");
                }, 450);
              } // eind geheel nieuw
              else {
                document
                  .getElementById("kvk-resultaat")
                  .classList.remove("ladend");
              }
            });
        }

        document.getElementsByTagName("body")[0],
          addEventListener("click", function (e) {
            if (e.target.hasAttribute("data-kvk-nr")) {
              haalKvkInfoEnPrint(e.target.getAttribute("data-kvk-nr"), false);
            }
          });

        document
          .getElementById("sluit-kvk-paneel")
          .addEventListener("click", function () {
            document.getElementById("sluit-kvk-paneel").classList.add("groot");
            setTimeout(function () {
              document.getElementById("kvk-paneel").classList.remove("open");
            }, 300);
            setTimeout(function () {
              document
                .getElementById("sluit-kvk-paneel")
                .classList.remove("groot");
            }, 500);
          });
      };

      function datediff(first, second) {
        // Take the difference between the dates and divide by milliseconds per day.
        // Round to nearest whole number to deal with DST.
        return Math.round((second - first) / (1000 * 60 * 60 * 24));
      }

      async function zetMapInfo(faillissementen) {
        return new Promise((resolve) => {
          let alleDatums = faillissementen
            .map((f) => Number(f.datum.replace(/-/g, "999")))
            .filter((datum) => datum > 20209990199901);
          let hoogsteDatum = Math.max(...alleDatums)
            .toString()
            .replace(/[9]{3}/g, "-");
          let laagsteDatum = Math.min(...alleDatums)
            .toString()
            .replace(/[9]{3}/g, "-");
          document.getElementById(
            "map-info"
          ).innerHTML = `${faillissementen.length} faillissementsadressen uit de periode ${laagsteDatum} tot ${hoogsteDatum}`;
          resolve();
        });
      }
    </script>
  </body>
</html>
